# –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ —Å express-session –Ω–∞ JWT

**–°—Ç–∞—Ç—É—Å:** –í –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 01.12.2025  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–í—ã–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:** B+ (Dual httpOnly Cookies)

---

## üìã –û–±–∑–æ—Ä

–ü–µ—Ä–µ—Ö–æ–¥ —Å —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–µ—Å—Å–∏–π (PostgreSQL) –Ω–∞ **Dual httpOnly Cookie JWT —Å—Ç—Ä–∞—Ç–µ–≥–∏—é** –¥–ª—è —Ä–µ—à–µ–Ω–∏—è:
- ‚ùå –í—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å ‚Üí session.save())
- ‚ùå –°–ª–æ–∂–Ω–æ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏ (verifySessionInDatabase, sessionRefresh)
- ‚ùå CSRF race conditions (—Ç–æ–∫–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏)
-‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Stateless –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ –ë–î, –ø–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç XSS –∏ CSRF.

---

## üèóÔ∏è –§–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (B+ Strategy)

### Access Token (JWT) - 15 –º–∏–Ω—É—Ç
```json
{
  "userId": "uuid",
  "roles": ["customer", "admin"],
  "v": 5,
  "iat": 1733051234,
  "exp": 1733052134
}
```
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** httpOnly cookie (path: `/`, XSS protection)
- **TTL:** 15 –º–∏–Ω—É—Ç
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ë—ã—Å—Ç—Ä–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT –ë–ï–ó –ë–î (stateless)
- **–û—Ç–ø—Ä–∞–≤–∫–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º –Ω–∞ –≤—Å–µ `/api/*` –∑–∞–ø—Ä–æ—Å—ã
- **–ó–∞—â–∏—Ç–∞:** –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç XSS (httpOnly) –∏ CSRF (SameSite: Strict)

### Refresh Token (JWT) - 7 –¥–Ω–µ–π
```json
{
  "userId": "uuid",
  "jti": "unique-token-id",
  "iat": 1733051234,
  "exp": 1733656034
}
```
- **–•—Ä–∞–Ω–µ–Ω–∏–µ:** httpOnly cookie (path: `/api/auth/refresh`, XSS protection)
- **TTL:** 7 –¥–Ω–µ–π
- **–ü—Ä–æ–≤–µ—Ä–∫–∞:** JWT + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î (jti –≤ whitelist?)
- **–û—Ç–ø—Ä–∞–≤–∫–∞:** –¢–æ–ª—å–∫–æ –Ω–∞ `/api/auth/refresh` endpoint
- **–ó–∞—â–∏—Ç–∞:** –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç XSS (httpOnly) –∏ CSRF (SameSite: Strict)
- **Revocation:** –£–¥–∞–ª–µ–Ω–∏–µ jti –∏–∑ –ë–î ‚Üí —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω

### Token Versioning
–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø–æ–ª–µ `tokenVersion` –≤ –ë–î. –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö (–±–∞–Ω, —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è) –≤–µ—Ä—Å–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è, –¥–µ–ª–∞—è –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ access tokens –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏.

**–°—Ö–µ–º–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î: { id: "123", tokenVersion: 5 }
Access Token: { userId: "123", v: 5 }  ‚úì –≤–∞–ª–∏–¥–µ–Ω
–ü–æ—Å–ª–µ –±–∞–Ω–∞: user.tokenVersion = 6
Access Token: { userId: "123", v: 5 }  ‚úó –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (v < 6)
```

---

## üì¶ –≠—Ç–∞–ø 1: –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 1.1 –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤–µ—Ä—Å–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü—É `users`

**–§–∞–π–ª:** `shared/schema.ts`

```typescript
export const users = pgTable("users", {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
  tokenVersion: integer("token_version").default(1).notNull(), // ‚Üê –î–û–ë–ê–í–ò–¢–¨
  banned: boolean("banned").default(false).notNull(),
  deletedAt: timestamp("deleted_at"),
});
```

### 1.2 –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `refreshTokens`

**–§–∞–π–ª:** `shared/schema.ts`

```typescript
export const refreshTokens = pgTable("refresh_tokens", {
  id: varchar("id").primaryKey().$defaultFn(() => nanoid()),
  userId: varchar("user_id").notNull().references(() => users.id, { onDelete: 'cascade' }),
  jti: varchar("jti", { length: 64 }).notNull().unique(), // JWT ID
  expiresAt: timestamp("expires_at").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  userAgent: text("user_agent"), // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
  ipAddress: text("ip_address"),
}, (table) => ({
  userIdIdx: index("refresh_tokens_user_id_idx").on(table.userId),
  jtiIdx: index("refresh_tokens_jti_idx").on(table.jti),
  expiresAtIdx: index("refresh_tokens_expires_at_idx").on(table.expiresAt),
}));
```

### 1.3 –î–æ–±–∞–≤–∏—Ç—å relations

```typescript
export const usersRelations = relations(users, ({ many }) => ({
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ relations ...
  refreshTokens: many(refreshTokens),
}));

export const refreshTokensRelations = relations(refreshTokens, ({ one }) => ({
  user: one(users, {
    fields: [refreshTokens.userId],
    references: [users.id],
  }),
}));
```

### 1.4 –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
npm run db:push
```

### 1.5 –ü–ª–∞–Ω —É–¥–∞–ª–µ–Ω–∏—è sessions —Ç–∞–±–ª–∏—Ü—ã (–ü–û–°–õ–ï –º–∏–≥—Ä–∞—Ü–∏–∏)

–¢–∞–±–ª–∏—Ü–∞ `sessions` –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ JWT –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏.

---

## üîß –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ JWT —É—Ç–∏–ª–∏—Ç

### 2.1 –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–§–∞–π–ª:** `server/env.ts`

```typescript
const envSchema = z.object({
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
  JWT_SECRET: z.string().min(32, 'JWT_SECRET must be at least 32 characters long'),
  JWT_REFRESH_SECRET: z.string().min(32, 'JWT_REFRESH_SECRET must be at least 32 characters long'),
});
```

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ env.ts):**
```typescript
if (!process.env.JWT_SECRET) {
  if (process.env.NODE_ENV === 'production') {
    console.error('‚ùå JWT_SECRET –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤ production');
    process.exit(1);
  }
  const generatedSecret = randomBytes(32).toString('hex');
  process.env.JWT_SECRET = generatedSecret;
  console.log('‚ö†Ô∏è  JWT_SECRET –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è development');
}

if (!process.env.JWT_REFRESH_SECRET) {
  if (process.env.NODE_ENV === 'production') {
    console.error('‚ùå JWT_REFRESH_SECRET –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤ production');
    process.exit(1);
  }
  const generatedSecret = randomBytes(32).toString('hex');
  process.env.JWT_REFRESH_SECRET = generatedSecret;
  console.log('‚ö†Ô∏è  JWT_REFRESH_SECRET –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è development');
}
```

### 2.2 –°–æ–∑–¥–∞—Ç—å JWT —É—Ç–∏–ª–∏—Ç—ã

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `server/utils/jwt.ts`

```typescript
import jwt from 'jsonwebtoken';
import { nanoid } from 'nanoid';
import { env } from '../env';

export interface AccessTokenPayload {
  userId: string;
  roles: string[];
  v: number;  // token version
  iat: number;
  exp: number;
}

export interface RefreshTokenPayload {
  userId: string;
  jti: string;
  iat: number;
  exp: number;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è access token
export function generateAccessToken(
  userId: string, 
  roles: string[], 
  tokenVersion: number
): string {
  return jwt.sign(
    { userId, roles, v: tokenVersion },
    env.JWT_SECRET,
    { expiresIn: '15m' }
  );
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è refresh token
export function generateRefreshToken(userId: string): { token: string; jti: string } {
  const jti = nanoid();
  const token = jwt.sign(
    { userId, jti },
    env.JWT_REFRESH_SECRET,
    { expiresIn: '7d' }
  );
  return { token, jti };
}

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è access token
export function verifyAccessToken(token: string): AccessTokenPayload {
  return jwt.verify(token, env.JWT_SECRET) as AccessTokenPayload;
}

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è refresh token
export function verifyRefreshToken(token: string): RefreshTokenPayload {
  return jwt.verify(token, env.JWT_REFRESH_SECRET) as RefreshTokenPayload;
}
```

### 2.3 –°–æ–∑–¥–∞—Ç—å –∫–µ—à –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `server/utils/userCache.ts`

```typescript
import { storage } from '../storage';

interface CachedUserStatus {
  banned: boolean;
  deletedAt: Date | null;
  tokenVersion: number;
  cachedAt: number;
}

const userCache = new Map<string, CachedUserStatus>();
const CACHE_TTL = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç

export async function getUserStatus(userId: string): Promise<CachedUserStatus> {
  const cached = userCache.get(userId);
  const now = Date.now();
  
  if (cached && now - cached.cachedAt < CACHE_TTL) {
    return cached;
  }
  
  const user = await storage.getUser(userId);
  
  if (!user) {
    throw new Error('User not found');
  }
  
  const status: CachedUserStatus = {
    banned: user.banned || false,
    deletedAt: user.deletedAt || null,
    tokenVersion: user.tokenVersion || 1,
    cachedAt: now
  };
  
  userCache.set(userId, status);
  return status;
}

export function invalidateUserCache(userId: string): void {
  userCache.delete(userId);
}

export function clearUserCache(): void {
  userCache.clear();
}
```

---

## üîê –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Storage Layer

### 3.1 –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –¥–ª—è refresh tokens

**–§–∞–π–ª:** `server/storage.ts`

```typescript
// –°–æ–∑–¥–∞—Ç—å refresh token
async createRefreshToken(params: {
  userId: string;
  jti: string;
  expiresAt: Date;
  userAgent?: string;
  ipAddress?: string;
}) {
  return db.insert(refreshTokens).values(params).returning();
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ refresh token
async validateRefreshToken(jti: string): Promise<boolean> {
  const token = await db.query.refreshTokens.findFirst({
    where: eq(refreshTokens.jti, jti),
  });
  
  if (!token) return false;
  if (new Date(token.expiresAt) < new Date()) {
    await this.deleteRefreshToken(jti);
    return false;
  }
  
  return true;
}

// –£–¥–∞–ª–∏—Ç—å refresh token (logout)
async deleteRefreshToken(jti: string) {
  return db.delete(refreshTokens).where(eq(refreshTokens.jti, jti));
}

// –£–¥–∞–ª–∏—Ç—å –≤—Å–µ refresh tokens –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async deleteAllRefreshTokens(userId: string) {
  return db.delete(refreshTokens).where(eq(refreshTokens.userId, userId));
}

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ refresh tokens –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è UI)
async getUserRefreshTokens(userId: string) {
  return db.query.refreshTokens.findMany({
    where: eq(refreshTokens.userId, userId),
    orderBy: [desc(refreshTokens.createdAt)],
  });
}

// –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä—Å–∏—é —Ç–æ–∫–µ–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π logout)
async incrementTokenVersion(userId: string): Promise<number> {
  const [updated] = await db.update(users)
    .set({ tokenVersion: sql`${users.tokenVersion} + 1` })
    .where(eq(users.id, userId))
    .returning({ newVersion: users.tokenVersion });
  return updated.newVersion;
}
```

---

## üõ°Ô∏è –≠—Ç–∞–ø 4: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Authentication Middleware

### 4.1 –û–±–Ω–æ–≤–∏—Ç—å auth middleware

**–§–∞–π–ª:** `server/auth.ts`

```typescript
import { type Request, type Response, type NextFunction } from "express";
import { verifyAccessToken } from "./utils/jwt";
import { getUserStatus, invalidateUserCache } from "./utils/userCache";
import { logger } from "./utils/logger";

export async function authenticateToken(
  req: Request,
  res: Response,
  next: NextFunction
): Promise<void> {
  try {
    // –ü–æ–ª—É—á–∞–µ–º access token –∏–∑ httpOnly cookie
    const token = req.cookies.accessToken;

    if (!token) {
      res.status(401).json({ message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è' });
      return;
    }

    // –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º JWT –ø–æ–¥–ø–∏—Å—å
    let payload;
    try {
      payload = verifyAccessToken(token);
    } catch (error) {
      res.status(401).json({ message: '–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω' });
      return;
    }

    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–µ—à–∞ (—Å –≤–µ—Ä—Å–∏–µ–π!)
    const userStatus = await getUserStatus(payload.userId);

    // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –í–ï–†–°–ò–ò
    if (payload.v < userStatus.tokenVersion) {
      logger.warn('Revoked token attempt', {
        userId: payload.userId,
        tokenVersion: payload.v,
        currentVersion: userStatus.tokenVersion
      });
      res.status(401).json({ message: '–¢–æ–∫–µ–Ω –æ—Ç–æ–∑–≤–∞–Ω' });
      return;
    }

    // –û–±—ã—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (userStatus.deletedAt) {
      res.status(401).json({ message: '–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω' });
      return;
    }
    
    if (userStatus.banned) {
      res.status(401).json({ message: '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' });
      return;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ request
    req.userId = payload.userId;
    req.userRoles = payload.roles;

    next();
  } catch (error) {
    logger.error('Authentication error', { error });
    res.status(401).json({ message: '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏' });
  }
}

// requireRole –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

---

## üîÑ –≠—Ç–∞–ø 5: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Auth Routes

### 5.1 –û–±–Ω–æ–≤–∏—Ç—å register

**–§–∞–π–ª:** `server/routes/auth.routes.ts`

```typescript
import { generateAccessToken, generateRefreshToken } from "../utils/jwt";
import { invalidateUserCache } from "../utils/userCache";

router.post("/register", registerLimiter, async (req, res) => {
  // ... –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ...
  
  const roles = await storage.getUserRoles(user.id);
  const roleNames = roles.map(r => r.role);
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω—ã
  const accessToken = generateAccessToken(user.id, roleNames, 1); // tokenVersion = 1
  const { token: refreshToken, jti } = generateRefreshToken(user.id);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º refresh token –≤ –ë–î
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  await storage.createRefreshToken({
    userId: user.id,
    jti,
    expiresAt,
    userAgent: req.get('user-agent'),
    ipAddress: req.ip,
  });
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º httpOnly cookies
  res.cookie('accessToken', accessToken, {
    httpOnly: true,
    secure: env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
    path: '/',
  });
  
  res.cookie('refreshToken', refreshToken, {
    httpOnly: true,
    secure: env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
    path: '/api/auth/refresh', // ‚Üê –ö–†–ò–¢–ò–ß–ù–û! –¢–æ–ª—å–∫–æ –Ω–∞ refresh endpoint
  });
  
  logRegistration({
    email: user.email,
    userId: user.id,
    ip: req.ip,
    userAgent: req.get('user-agent'),
  });

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ user data (—Ç–æ–∫–µ–Ω—ã –≤ cookies!)
  res.json({
    user: {
      id: user.id,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      phone: user.phone,
      isVerified: user.isVerified,
      bonusBalance: user.bonusBalance,
      roles: roleNames,
    },
  });
});
```

### 5.2 –û–±–Ω–æ–≤–∏—Ç—å login (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ register)

### 5.3 –°–æ–∑–¥–∞—Ç—å refresh endpoint

```typescript
router.post("/refresh", async (req, res) => {
  try {
    // Refresh token –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ cookie
    const refreshToken = req.cookies.refreshToken;
    
    if (!refreshToken) {
      return res.status(401).json({ message: 'Refresh token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' });
    }
    
    // –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è refresh token
    let payload;
    try {
      payload = verifyRefreshToken(refreshToken);
    } catch (error) {
      return res.status(401).json({ message: '–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π refresh token' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î
    const isValid = await storage.validateRefreshToken(payload.jti);
    if (!isValid) {
      return res.status(401).json({ message: 'Refresh token –æ—Ç–æ–∑–≤–∞–Ω' });
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–æ–ª–∏
    const user = await storage.getUser(payload.userId);
    if (!user) {
      return res.status(401).json({ message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    const userRoles = await storage.getUserRoles(user.id);
    const roles = userRoles.map(r => r.role);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π access token —Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π
    const newAccessToken = generateAccessToken(user.id, roles, user.tokenVersion);
    
    // REFRESH TOKEN ROTATION (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    const { token: newRefreshToken, jti: newJti } = generateRefreshToken(user.id);
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π refresh token
    await storage.deleteRefreshToken(payload.jti);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π refresh token
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    await storage.createRefreshToken({
      userId: user.id,
      jti: newJti,
      expiresAt,
      userAgent: req.get('user-agent'),
      ipAddress: req.ip,
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ cookies
    res.cookie('accessToken', newAccessToken, {
      httpOnly: true,
      secure: env.NODE_ENV === 'production',
      sameSite: 'strict',
      maxAge: 15 * 60 * 1000,
      path: '/',
    });
    
    res.cookie('refreshToken', newRefreshToken, {
      httpOnly: true,
      secure: env.NODE_ENV === 'production',
      sameSite: 'strict',
      maxAge: 7 * 24 * 60 * 60 * 1000,
      path: '/api/auth/refresh',
    });
    
    res.json({ success: true });
  } catch (error) {
    logger.error('Token refresh error', { error });
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞' });
  }
});
```

### 5.4 –û–±–Ω–æ–≤–∏—Ç—å logout

```typescript
router.post("/logout", authenticateToken, async (req, res) => {
  try {
    // –£–¥–∞–ª—è–µ–º refresh token –∏–∑ –ë–î
    const refreshToken = req.cookies.refreshToken;
    if (refreshToken) {
      try {
        const payload = verifyRefreshToken(refreshToken);
        await storage.deleteRefreshToken(payload.jti);
      } catch (error) {
        // Ignore invalid token
      }
    }
    
    // –û—á–∏—â–∞–µ–º cookies
    res.clearCookie('accessToken', { path: '/' });
    res.clearCookie('refreshToken', { path: '/api/auth/refresh' });
    
    res.json({ message: '–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω' });
  } catch (error) {
    logger.error('Logout error', { error });
    res.status(500).json({ message: '–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞' });
  }
});
```

### 5.5 –°–æ–∑–¥–∞—Ç—å /me endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞

```typescript
router.get("/me", authenticateToken, async (req, res) => {
  const user = await storage.getUser(req.userId!);
  
  if (!user) {
    return res.status(404).json({ message: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" });
  }

  const roles = await storage.getUserRoles(user.id);
  const roleNames = roles.map(r => r.role);

  res.json({
    user: {
      id: user.id,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      patronymic: user.patronymic,
      phone: user.phone,
      isVerified: user.isVerified,
      bonusBalance: user.bonusBalance,
      roles: roleNames,
    },
  });
});
```

### 5.6 –û–±–Ω–æ–≤–∏—Ç—å change password (–≥–ª–æ–±–∞–ª—å–Ω—ã–π logout)

```typescript
router.put("/password", authenticateToken, passwordChangeLimiter, async (req, res) => {
  // ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è ...
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
  await storage.updateUser(req.userId!, {
    passwordHash: newPasswordHash,
  });
  
  // –£–í–ï–õ–ò–ß–ò–í–ê–ï–ú –í–ï–†–°–ò–Æ –¢–û–ö–ï–ù–ê - –ì–õ–û–ë–ê–õ–¨–ù–´–ô LOGOUT
  const newVersion = await storage.incrementTokenVersion(req.userId!);
  
  // –£–¥–∞–ª—è–µ–º –í–°–ï refresh tokens
  await storage.deleteAllRefreshTokens(req.userId!);
  
  // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫–µ—à
  invalidateUserCache(req.userId!);
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  const user = await storage.getUser(req.userId!);
  const userRoles = await storage.getUserRoles(req.userId!);
  const roles = userRoles.map(r => r.role);
  
  const accessToken = generateAccessToken(req.userId!, roles, newVersion);
  const { token: refreshToken, jti } = generateRefreshToken(req.userId!);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π refresh token
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  await storage.createRefreshToken({
    userId: req.userId!,
    jti,
    expiresAt,
    userAgent: req.get('user-agent'),
    ipAddress: req.ip,
  });
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ cookies
  res.cookie('accessToken', accessToken, {
    httpOnly: true,
    secure: env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 15 * 60 * 1000,
    path: '/',
  });
  
  res.cookie('refreshToken', refreshToken, {
    httpOnly: true,
    secure: env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000,
    path: '/api/auth/refresh',
  });
  
  res.json({ 
    message: '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω. –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ—Ç–∫–ª—é—á–µ–Ω—ã, –≤—ã –≤–æ—à–ª–∏ –∑–∞–Ω–æ–≤–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.' 
  });
});
```

---

## üóëÔ∏è –≠—Ç–∞–ø 6: –£–¥–∞–ª–µ–Ω–∏–µ Session –∏ CSRF Middleware

### 6.1 –û–±–Ω–æ–≤–∏—Ç—å server/index.ts

**–£–î–ê–õ–ò–¢–¨:**
```typescript
import { sessionMiddleware } from "./session";
import { sessionRefreshMiddleware } from "./middleware/sessionRefresh";
import { csrfMiddleware, csrfTokenEndpoint } from "./middleware/csrf";

app.use(sessionMiddleware);
app.use(sessionRefreshMiddleware);
app.use('/api', csrfMiddleware);
app.get('/api/csrf-token-init', authenticateToken, csrfTokenEndpoint);
```

**–î–û–ë–ê–í–ò–¢–¨:**
```typescript
import cookieParser from "cookie-parser";

app.use(cookieParser()); // ‚Üê –î–ª—è —á—Ç–µ–Ω–∏—è cookies
```

### 6.2 –û–±–Ω–æ–≤–∏—Ç—å CORS

```typescript
app.use(corsMiddleware); // —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å credentials: true
```

–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤ `server/middleware/cors.ts`:
```typescript
credentials: true,  // ‚Üê –î–æ–ª–∂–Ω–æ –±—ã—Ç—å true –¥–ª—è httpOnly cookies
```

### 6.3 –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã

–ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- `server/session.ts`
- `server/utils/sessionUtils.ts`
- `server/utils/sessionManager.ts`
- `server/middleware/sessionRefresh.ts`
- `server/middleware/csrf.ts`

### 6.4 –£–¥–∞–ª–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (package.json)

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
npm uninstall express-session connect-pg-simple csrf-csrf memorystore
```

---

## üé® –≠—Ç–∞–ø 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Frontend

### 7.1 –û–±–Ω–æ–≤–∏—Ç—å Auth Store

**–§–∞–π–ª:** `client/src/stores/authStore.ts`

```typescript
// –£–±—Ä–∞—Ç—å –≤—Å—ë, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å CSRF —Ç–æ–∫–µ–Ω–∞–º–∏
// –¢–æ–∫–µ–Ω—ã —Ç–µ–ø–µ—Ä—å –≤ httpOnly cookies, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Ö –Ω–µ –≤–∏–¥–∏—Ç

interface AuthState {
  user: User | null;
  loading: boolean;
  setUser: (user: User | null) => void;
  setLoading: (loading: boolean) => void;
  clearAuth: () => void;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  loading: true,
  
  setUser: (user) => set({ user }),
  setLoading: (loading) => set({ loading }),
  
  clearAuth: () => set({ user: null, loading: false }),
}));
```

### 7.2 –û–±–Ω–æ–≤–∏—Ç—å API Client

**–§–∞–π–ª:** `client/src/lib/api.ts`

```typescript
import axios from 'axios';
import { useAuthStore } from '../stores/authStore';

export const api = axios.create({
  baseURL: '/api',
  withCredentials: true, // ‚Üê –ö–†–ò–¢–ò–ß–ù–û! –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç httpOnly cookies
});

// –£–±—Ä–∞—Ç—å interceptor –¥–ª—è CSRF —Ç–æ–∫–µ–Ω–æ–≤

// –û–±–Ω–æ–≤–∏—Ç—å response interceptor –¥–ª—è auto-refresh
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    // –ï—Å–ª–∏ 401 –∏ –Ω–µ retry
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      try {
        // Refresh token –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ cookie
        await axios.post('/api/auth/refresh', {}, {
          withCredentials: true
        });

        // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        return api(originalRequest);
      } catch (refreshError) {
        // Refresh failed - –ø–æ–ª–Ω—ã–π logout
        useAuthStore.getState().clearAuth();
        window.location.href = '/login';
        return Promise.reject(refreshError);
      }
    }

    return Promise.reject(error);
  }
);
```

### 7.3 –û–±–Ω–æ–≤–∏—Ç—å Auth Provider

**–§–∞–π–ª:** `client/src/providers/auth-provider.tsx`

```typescript
import { useEffect } from 'react';
import { useAuthStore } from '../stores/authStore';
import { api } from '../lib/api';

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const { setUser, setLoading } = useAuthStore();

  useEffect(() => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º auth —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const checkAuth = async () => {
      try {
        // Cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        const response = await api.get('/auth/me');
        setUser(response.data.user);
      } catch (error) {
        setUser(null);
      } finally {
        setLoading(false);
      }
    };

    checkAuth();
  }, [setUser, setLoading]);

  return <>{children}</>;
}
```

### 7.4 –û–±–Ω–æ–≤–∏—Ç—å Login/Register –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–£–±—Ä–∞—Ç—å –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–æ–≤:

```typescript
// Login
const handleLogin = async (data: LoginFormData) => {
  const response = await api.post('/auth/login', data);
  // –¢–æ–∫–µ–Ω—ã —É–∂–µ –≤ httpOnly cookies!
  setUser(response.data.user);
  navigate('/');
};

// Register (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
```

### 7.5 –û–±–Ω–æ–≤–∏—Ç—å Logout

```typescript
const handleLogout = async () => {
  await api.post('/auth/logout');
  // Cookies –æ—á–∏—â–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
  clearAuth();
  navigate('/login');
};
```

---

## üîå –≠—Ç–∞–ø 8: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ WebSocket Authentication

### 8.1 –û–±–Ω–æ–≤–∏—Ç—å WebSocket handler

**–§–∞–π–ª:** `server/routes.ts`

```typescript
// –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å user ID
wss.on('connection', async (ws, req) => {
  let authenticated = false;
  let userId: string | null = null;

  ws.on('message', async (data) => {
    const message = JSON.parse(data.toString());

    if (!authenticated && message.type === 'auth') {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º cookie –∏–∑ handshake
      const cookies = parseCookies(req.headers.cookie || '');
      const accessToken = cookies.accessToken;

      if (!accessToken) {
        ws.close(1008, 'Unauthorized');
        return;
      }

      try {
        const payload = verifyAccessToken(accessToken);
        const userStatus = await getUserStatus(payload.userId);

        if (payload.v < userStatus.tokenVersion || userStatus.banned || userStatus.deletedAt) {
          ws.close(1008, 'Unauthorized');
          return;
        }

        authenticated = true;
        userId = payload.userId;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ connections
        // ...
      } catch (error) {
        ws.close(1008, 'Unauthorized');
        return;
      }
    }

    if (!authenticated) {
      ws.close(1008, 'Not authenticated');
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    // ...
  });
});
```

### 8.2 –û–±–Ω–æ–≤–∏—Ç—å Frontend WebSocket

**–§–∞–π–ª:** `client/src/lib/websocket.ts`

```typescript
// –ü—Ä–æ—Å—Ç–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è, cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);

ws.onopen = () => {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º auth —Å–æ–æ–±—â–µ–Ω–∏–µ
  ws.send(JSON.stringify({ type: 'auth' }));
};
```

---

## üß™ –≠—Ç–∞–ø 9: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 9.1 –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –æ–±–∞ cookie (accessToken, refreshToken)
- [ ] Login —Å–æ–∑–¥–∞—ë—Ç –æ–±–∞ cookie
- [ ] Protected routes —Ä–∞–±–æ—Ç–∞—é—Ç —Å access token
- [ ] Refresh —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ access token
- [ ] Logout –æ—á–∏—â–∞–µ—Ç –æ–±–∞ cookie –∏ —É–¥–∞–ª—è–µ—Ç refresh token –∏–∑ –ë–î
- [ ] –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç tokenVersion –∏ –æ—á–∏—â–∞–µ—Ç –≤—Å–µ refresh tokens
- [ ] –ë–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å
- [ ] WebSocket –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Page refresh —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (—á–µ—Ä–µ–∑ /auth/me)

### 9.2 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] httpOnly cookies –Ω–µ —á–∏—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript (console: `document.cookie`)
- [ ] SameSite: Strict –±–ª–æ–∫–∏—Ä—É–µ—Ç cross-site –∑–∞–ø—Ä–æ—Å—ã
- [ ] Refresh token –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ `/api/auth/refresh`
- [ ] Access token –∏–º–µ–µ—Ç TTL 15 –º–∏–Ω—É—Ç
- [ ] Refresh token –∏–º–µ–µ—Ç TTL 7 –¥–Ω–µ–π
- [ ] Token versioning —Ä–∞–±–æ—Ç–∞–µ—Ç (–±–∞–Ω ‚Üí –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã)

### 9.3 –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ú–µ—Ç—Ä–∏–∫–∏:**
- [ ] –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î —Å–Ω–∏–∂–µ–Ω—ã –Ω–∞ 95% (—Ç–æ–ª—å–∫–æ refresh —Ä–∞–∑ –≤ 15 –º–∏–Ω)
- [ ] User cache —Ä–∞–±–æ—Ç–∞–µ—Ç (10 –º–∏–Ω TTL)
- [ ] Access token –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –ë–î (stateless)

---

## üöÄ –≠—Ç–∞–ø 10: –ú–∏–≥—Ä–∞—Ü–∏—è Production

### 10.1 –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

**Hard Cutoff (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã):**

1. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ 24 —á–∞—Å–∞
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (–¥–æ–±–∞–≤–∏—Ç—å tokenVersion, refreshTokens)
3. –î–µ–ø–ª–æ–π –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
4. –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ logout ‚Üí –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
5. –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É sessions —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π

### 10.2 Environment Variables Production

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ production environment:
JWT_SECRET=<—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ openssl rand -hex 32>
JWT_REFRESH_SECRET=<—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ openssl rand -hex 32>
```

### 10.3 Rollback Plan

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫:

1. –í–µ—Ä–Ω—É—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞ (—Å sessions)
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç–µ—Ä—è—é—Ç refresh tokens, –Ω–æ —Å–µ—Å—Å–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è
3. tokenVersion –∏ refreshTokens —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –º–µ—à–∞—é—Ç —Å—Ç–∞—Ä–æ–º—É –∫–æ–¥—É

---

## üìã –ò—Ç–æ–≥–æ–≤—ã–π Checklist

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `tokenVersion` –≤ —Ç–∞–±–ª–∏—Ü—É `users`
- [ ] –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `refreshTokens` —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã relations
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω `npm run db:push`

### Backend
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã JWT_SECRET –∏ JWT_REFRESH_SECRET –≤ env
- [ ] –°–æ–∑–¥–∞–Ω `server/utils/jwt.ts`
- [ ] –°–æ–∑–¥–∞–Ω `server/utils/userCache.ts`
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω `server/storage.ts` (–º–µ—Ç–æ–¥—ã –¥–ª—è refresh tokens)
- [ ] –ü–µ—Ä–µ–ø–∏—Å–∞–Ω `server/auth.ts` (authenticateToken)
- [ ] –ü–µ—Ä–µ–ø–∏—Å–∞–Ω—ã auth routes (login, register, refresh, logout, /me)
- [ ] –£–¥–∞–ª–µ–Ω—ã session/CSRF middleware –∏–∑ index.ts
- [ ] –î–æ–±–∞–≤–ª–µ–Ω cookie-parser
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ WebSocket –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

### Frontend
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω auth store (—É–±—Ä–∞–Ω CSRF)
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω API client (withCredentials, auto-refresh)
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω Auth Provider (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ /me)
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã Login/Register –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- [ ] –û–±–Ω–æ–≤–ª—ë–Ω WebSocket client

### Cleanup (–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- [ ] –£–¥–∞–ª–µ–Ω—ã —Ñ–∞–π–ª—ã session/CSRF
- [ ] –£–¥–∞–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ package.json
- [ ] –£–¥–∞–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ sessions –∏–∑ –ë–î

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (XSS, CSRF)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Production
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã production secrets
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
- [ ] –î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–î–æ –º–∏–≥—Ä–∞—Ü–∏–∏:**
- üî¥ 1000+ –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ –∫ –ë–î (session.save())
- üî¥ Race conditions —Å CSRF —Ç–æ–∫–µ–Ω–∞–º–∏
- üî¥ –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ session refresh
- ‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —é–∑–µ—Ä–∞ —á–µ—Ä–µ–∑ 14 –¥–Ω–µ–π (TTL —Å–µ—Å—Å–∏–∏)

**–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:**
- ‚úÖ 1-5 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ –∫ –ë–î (—Ç–æ–ª—å–∫–æ refresh)
- ‚úÖ –ù–µ—Ç race conditions (stateless access token)
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ (JWT verify)
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —é–∑–µ—Ä–∞ —á–µ—Ä–µ–∑ <10 –º–∏–Ω—É—Ç (token versioning + cache TTL)
- ‚úÖ –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç XSS (httpOnly cookies)
- ‚úÖ –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç CSRF (SameSite: Strict)

---

**–ö–æ–Ω–µ—Ü –ø–ª–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏–∏**
